<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظام إدارة الأسرة والموارد التمريضية الذكي</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- خط تجميلي -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #F7F9FD;
      color: #1A3A7A;
    }

    :root {
      --primary: #0A1D41;
      --primary-dark: #0A1D41;
      --secondary: #A8AD63;
      --complement: #8A8F40;
      --interactive: #1A3A7A;
      --accent: #A8AD63;
      --bg-card: #ffffff;
      --bg-light: #FFFFFF;
      --border-soft: rgba(195, 199, 115, 0.5);
      --danger: #e53935;
      --warning: #ffb300;
      --success: #2e7d32;
      --isolation: #7b1fa2;
      --muted: #90a4ae;
    }

    body {
      background: #F7F9FD;
      min-height: 100vh;
      padding-bottom: 40px;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--primary);
      color: #FFFFFF;
      padding: 18px 26px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      border-bottom: 2px solid rgba(255, 255, 255, 0.15);
      position: sticky;
      top: 0;
      z-index: 20;
      letter-spacing: 0.5px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-circle {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 15px;
      background: rgba(10, 86, 179, 0.1);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.15);
    }

    .header-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .header-title-main {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .header-title-sub {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* الهيدر المخصص للجوال */
    .mobile-header {
      display: none;
      background: #0A1D41;
      color: #ffffff;
      padding: 14px 20px;
      font-size: 18px;
      font-weight: 700;
      align-items: center;
      justify-content: space-between;
    }

    .mobile-menu-btn {
      font-size: 26px;
      cursor: pointer;
    }

    .mobile-menu {
      display: none;
      position: fixed;
      inset-inline-start: 0;
      top: 0;
      height: 100vh;
      width: 260px;
      background: #0A1D41;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
      z-index: 9999;
      overflow-y: auto;
    }

    .mobile-menu a {
      display: block;
      color: #ffffff;
      padding: 14px 0;
      font-size: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      text-decoration: none;
    }

    .mobile-menu-close {
      color: #ffffff;
      font-size: 26px;
      text-align: end;
      cursor: pointer;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      header,
      .top-buttons {
        display: none !important;
      }

      .mobile-header {
        display: flex !important;
      }
    }

    .nav-link {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .nav-link:active {
      transform: translateY(0);
    }


      font-size: 12px;
      color: var(--primary-dark);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    main {
      flex: 1;
      padding: 14px 18px 22px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr) 320px;
      gap: 14px;
      align-items: stretch;
    }

    .ai-analysis-card {
      grid-column: 2;
      margin-top: 14px;
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .ai-analysis-card {
        grid-column: 1;
      }

      .side-panel,
      .details-panel {
        order: -1;
      }
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .side-panel,
      .details-panel {
        order: 0;
        width: 100%;
      }
    }

    .card {
      background: linear-gradient(180deg, #ffffff, #f7f9fc);
      border-radius: 22px;
      padding: 26px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 6px 20px rgba(10, 29, 65, 0.08);
      backdrop-filter: blur(2px);
      transition: all 0.25s ease;
      width: 100%;
    }

    .details-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .details-panel .details {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      box-shadow: 0 12px 32px rgba(15, 37, 85, 0.15);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--secondary);
      letter-spacing: -0.01em;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .badge-light {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--bg-light);
      color: var(--interactive);
    }

    /* Sidebar Filters */
    .filters {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
      letter-spacing: -0.01em;
    }

    select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      font-size: 13px;
      outline: none;
      background: var(--bg-light);
      transition: all 0.2s ease;
      font-weight: 500;
    }

    select:hover {
      border-color: var(--complement);
    }

    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(10, 29, 65, 0.1);
      background: #ffffff;
    }

    .quick-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .stat-badge {
      padding: 10px;
      border-radius: 12px;
      background: var(--bg-light);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .stat-badge:hover {
      background: linear-gradient(180deg, #ffffff, #f7f9fc);
      border-color: var(--complement);
      box-shadow: 0 2px 8px rgba(10, 29, 65, 0.08);
    }

    .stat-badge strong {
      font-size: 15px;
      font-weight: 700;
      color: var(--complement);
    }

    .stat-badge span {
      color: var(--muted);
      font-weight: 500;
    }

    /* Map + Legend */
    .map-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill-group {
      display: inline-flex;
      padding: 3px;
      border-radius: 12px;
      background: #edf3ff;
      gap: 3px;
    }

    .pill {
      border-radius: 10px;
      padding: 4px 10px;
      font-size: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--primary-dark);
      opacity: 0.6;
      transition: all 0.2s ease;
    }

    .pill.active {
      background: #ffffff;
      opacity: 1;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(10, 56, 145, 0.12);
    }

    .map-wrapper {
      border-radius: 20px;
      border: 1px solid rgba(10, 56, 145, 0.08);
      background: radial-gradient(circle at top, #ffffff 0%, #f5f7fb 45%, #eef2fb 100%);
      padding: 20px;
      position: relative;
      overflow: hidden;
      min-height: 260px;
      box-shadow: inset 0 2px 8px rgba(15, 37, 85, 0.04);
    }

    .ward-label {
      position: absolute;
      top: 12px;
      inset-inline-start: 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: -0.01em;
    }

    .bed-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      margin-top: 32px;
    }

    @media (max-width: 900px) {
      .bed-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .bed-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 450px) {
      .bed-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .bed {
      position: relative;
      border-radius: 16px;
      padding: 10px 8px;
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 8px 20px rgba(15, 37, 85, 0.06);
      cursor: pointer;
      overflow: hidden;
      transition: all 0.22s ease;
    }

    .bed:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 28px rgba(15, 37, 85, 0.12);
      border-color: var(--primary);
    }

    .bed.selected {
      border: 2px solid #0a56b3;
      box-shadow: 0 0 0 4px rgba(10, 86, 179, 0.18),
        0 12px 30px rgba(15, 37, 85, 0.2);
    }

    .bed-head {
      position: absolute;
      top: 0;
      inset-inline-start: 0;
      width: 100%;
      height: 12px;
      background: linear-gradient(90deg, #0b0e5b, #0a56b3);
    }

    .bed-body {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid rgba(10, 86, 179, 0.06);
      padding: 8px 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: linear-gradient(135deg, #ffffff, #f5f8ff);
    }

    .bed-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .bed-id {
      font-size: 13px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .bed-status-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eceff1;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .bed-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--muted);
    }

    .bed-meta {
      font-size: 11px;
      color: #69809c;
      font-weight: 500;
    }

    /* Bed status colors */
    .status-free .bed-status-pill {
      background: rgba(46, 125, 50, 0.12);
      color: var(--success);
    }
    .status-free .bed-status-dot {
      background: var(--success);
    }

    .status-occupied .bed-status-pill {
      background: rgba(229, 57, 53, 0.12);
      color: var(--danger);
    }
    .status-occupied .bed-status-dot {
      background: var(--danger);
    }

    .status-discharge .bed-status-pill {
      background: rgba(255, 179, 0, 0.12);
      color: var(--warning);
    }
    .status-discharge .bed-status-dot {
      background: var(--warning);
    }

    .status-isolation .bed-status-pill {
      background: rgba(123, 31, 162, 0.12);
      color: var(--isolation);
    }
    .status-isolation .bed-status-dot {
      background: var(--isolation);
    }

    .status-outofservice .bed-status-pill {
      background: rgba(144, 164, 174, 0.2);
      color: var(--muted);
    }
    .status-outofservice .bed-status-dot {
      background: var(--muted);
    }

    .status-free .bed-body {
      background: linear-gradient(135deg, #d7f3e4, #f5fbf8);
      border: 1px solid rgba(46, 125, 50, 0.25);
    }
    .status-occupied .bed-body {
      background: linear-gradient(135deg, #ffe0e3, #fff3f4);
      border: 1px solid rgba(211, 47, 47, 0.25);
    }
    .status-discharge .bed-body {
      background: linear-gradient(135deg, #fff3d1, #fff8e6);
      border: 1px solid rgba(255, 179, 0, 0.3);
    }
    .status-isolation .bed-body {
      background: linear-gradient(135deg, #efd8ff, #f7edff);
      border: 1px solid rgba(123, 31, 162, 0.25);
    }
    .status-outofservice .bed-body {
      background: linear-gradient(135deg, #edf0f5, #f7f8fb);
      border: 1px solid rgba(144, 164, 174, 0.3);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      font-size: 11px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #f7f9ff;
      border: 1px solid rgba(10, 56, 145, 0.08);
      font-weight: 500;
      font-size: 12px;
      transition: all 0.2s ease;
    }

    .legend-item:hover {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(15, 37, 85, 0.1);
      transform: translateY(-1px);
    }

    .legend-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    .legend-dot.free {
      background: var(--success);
    }
    .legend-dot.occupied {
      background: var(--danger);
    }
    .legend-dot.discharge {
      background: var(--warning);
    }
    .legend-dot.isolation {
      background: var(--isolation);
    }
    .legend-dot.outofservice {
      background: var(--muted);
    }

    /* Details Panel */
    .details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .details-section {
      border-radius: 16px;
      padding: 16px;
      background: linear-gradient(180deg, #ffffff, #f7f9fc);
      border: 1px solid rgba(10, 29, 65, 0.08);
      box-shadow: 0 4px 14px rgba(10, 29, 65, 0.08);
    }

    .details-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .details-label {
      color: #243A5A;
      font-size: 12px;
      font-weight: 600;
    }

    .details-value {
      font-weight: 700;
      color: #0A1D41;
      font-size: 14px;
    }

    /* ==== تصميم مساعد التحويل الذكي المحسّن ==== */
    .ai-box {
      background: linear-gradient(180deg, #ffffff, #f8fbff);
      border: 1px solid rgba(10, 56, 145, 0.08);
      border-radius: 18px;
      padding: 22px;
      margin-top: 20px;
      box-shadow: 0 8px 22px rgba(15, 37, 85, 0.06);
    }

    .ai-title {
      font-size: 18px;
      font-weight: 700;
      color: #0b0e5b;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ai-section {
      margin-bottom: 18px;
      background: #f7f9ff;
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(10, 56, 145, 0.06);
    }

    .ai-section:last-child {
      margin-bottom: 0;
    }

    .ai-section-title {
      font-size: 13px;
      color: #0a56b3;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-score {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      background: rgba(39, 174, 96, 0.12);
      color: #27ae60;
    }

    .ai-score.medium {
      background: rgba(241, 196, 15, 0.18);
      color: #f39c12;
    }

    .ai-score.high {
      background: rgba(231, 76, 60, 0.18);
      color: #e74c3c;
    }

    .ai-reasons ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .ai-reasons li {
      margin-bottom: 8px;
      font-size: 13px;
      color: #4b5870;
      display: flex;
      gap: 8px;
      align-items: flex-start;
      line-height: 1.6;
    }

    .ai-reasons li:last-child {
      margin-bottom: 0;
    }

    .ai-badge {
      background: var(--bg-light);
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--interactive);
      display: inline-block;
      margin: 4px 6px 4px 0;
      border: 1px solid var(--border-soft);
    }

    .ai-recommend-text {
      font-size: 13px;
      color: #37445a;
      line-height: 1.7;
      font-weight: 500;
    }

    .ai-empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--muted);
    }

    .ai-empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .ai-empty-state-text {
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary {
      width: 100%;
      border-radius: 30px;
      border: none;
      padding: 10px;
      background: var(--primary);
      color: #FFFFFF;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(10, 29, 65, 0.2);
      display: inline-flex;
      justify-content: center;
    }

    .btn-secondary {
      width: 100%;
      border-radius: 30px;
      border: 2px solid var(--primary);
      padding: 10px;
      background: transparent;
      color: var(--primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      display: inline-flex;
      justify-content: center;
      align-items: center;
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-light);
      transform: translateY(-1px);
    }

    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 20px;
      padding: 28px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary-dark);
    }

    .modal-field {
      margin-bottom: 18px;
    }

    .modal-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 6px;
    }

    .modal-input,
    .modal-select,
    .modal-textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid rgba(10, 86, 179, 0.2);
      border-radius: 12px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    .modal-input:focus,
    .modal-select:focus,
    .modal-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(10, 86, 179, 0.1);
    }

    .modal-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-ai-check {
      background: #f7f9ff;
      border: 1px solid rgba(10, 86, 179, 0.1);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 18px;
    }

    .modal-ai-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-ai-status.checking {
      color: var(--primary);
    }

    .modal-ai-status.success {
      color: #27ae60;
    }

    .modal-ai-status.error {
      color: #e74c3c;
    }

    .modal-ai-status.warning {
      color: #f39c12;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #fff;
    }

    .modal-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(10, 86, 179, 0.3);
    }

    .modal-btn-secondary {
      background: #f5f7fb;
      color: var(--primary-dark);
      border: 1px solid rgba(10, 86, 179, 0.2);
    }

    .modal-btn-secondary:hover {
      background: #eef2fa;
    }

    .btn-primary:hover {
      box-shadow: 0 8px 22px rgba(10, 86, 179, 0.45);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0px);
      box-shadow: 0 4px 12px rgba(10, 86, 179, 0.4);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: 11px;
    }

    .chip-soft {
      padding: 4px 9px;
      border-radius: 999px;
      background: #edf3ff;
      color: var(--primary-dark);
      font-weight: 500;
      border: 1px solid rgba(10, 56, 145, 0.06);
      transition: all 0.2s ease;
    }

    .chip-soft:hover {
      background: #e0ebff;
      border-color: rgba(10, 86, 179, 0.12);
    }

    .muted {
      color: var(--muted);
    }

    /* ==== تصميم الغرف ==== */
    .rooms-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-top: 22px;
    }

    @media (max-width: 500px) {
      .rooms-grid {
        grid-template-columns: repeat(1, 1fr);
      }
    }

    .room-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 10px 24px rgba(15, 37, 85, 0.08);
      transition: all 0.25s ease;
      position: relative;
      cursor: pointer;
    }

    .room-card:hover {
      transform: translateY(-3px);
      border-color: #0a56b3;
      box-shadow: 0 14px 30px rgba(15, 37, 85, 0.15);
    }

    .room-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--primary-dark);
    }

    .room-bed {
      margin-top: 8px;
      padding: 12px;
      background: #f7f9ff;
      border-radius: 12px;
      border: 1px solid rgba(10, 56, 145, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-bed span {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-dark);
    }

    /* حالة الغرفة */
    .room-status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      margin-top: 10px;
    }

    .room-status-clean {
      background: rgba(46, 204, 113, 0.15);
      color: #27ae60;
    }

    .room-status-isolation {
      background: rgba(155, 89, 182, 0.18);
      color: #8e44ad;
    }

    .room-status-busy {
      background: rgba(231, 76, 60, 0.18);
      color: #e74c3c;
    }

    .toggle-wrapper {
      display: inline-flex;
      padding: 3px;
      border-radius: 12px;
      background: #edf3ff;
      gap: 3px;
    }

    .toggle-btn {
      border-radius: 10px;
      padding: 4px 10px;
      font-size: 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--primary-dark);
      opacity: 0.6;
      transition: all 0.2s ease;
    }

    .toggle-btn.active {
      background: #ffffff;
      opacity: 1;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(10, 56, 145, 0.12);
    }

    .toggle-btn:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
<div class="mobile-header">
  <span class="mobile-menu-btn" onclick="openMenu()">☰</span>
  <span>Masar</span>
</div>

<div id="mobileMenu" class="mobile-menu">
  <div class="mobile-menu-close" onclick="closeMenu()">×</div>
  <a href="main_dashboard.html">الرئيسية</a>
  <a href="smart_beds.html">خريطة الأسرة</a>
  <a href="control_panel.html">لوحة التحكم</a>
  <a href="transfer_requests.html">إدارة الطلبات</a>
</div>

<div class="app-shell">
  <!-- رأس الصفحة -->
  <header>
    <div class="header-left">
      <div class="logo-circle" aria-hidden="true"></div>
      <div class="header-title">
        <div class="header-title-main">Masar</div>
        <div class="header-title-sub">خريطة الأسرة التفاعلية</div>
      </div>
    </div>
    <div class="header-actions">
      <a href="main_dashboard.html" class="nav-link">
        الرئيسية
      </a>
      <a href="control_panel.html" class="nav-link">
         لوحة التحكم
      </a>
      <a href="transfer_requests.html" class="nav-link">
          إدارة الطلبات
      </a>
    </div>
  </header>

  <!-- Season Banner -->
  <div id="seasonBanner" style="
    display:none;
    background:#fff3cd;
    padding:14px 20px;
    color:#664d03;
    border:1px solid #ffeeba;
    border-radius:12px;
    margin:12px 18px;
    font-size:14px;
    box-shadow:0 2px 6px rgba(0,0,0,0.06);
  ">
    <strong>وضع موسم الحج مفعّل:</strong> تم رفع حساسية التحليل، وخفض حدود الضغط، وإعطاء أولوية لاستقبال الحالات الحرجة وتحويل الحالات المستقرة.
  </div>

  <main>
    <div class="layout">
      <!-- اللوحة الجانبية اليمنى (الفلتر) -->
      <aside class="card side-panel">
        <div class="card-header">
          <div>
            <div class="card-title">اختيار المبنى / الدور</div>
            <div class="card-subtitle">عرض أسرة مستشفى الملك عبدالعزيز</div>
          </div>
          <span class="badge-light">Real-time</span>
        </div>
        <div class="filters">
          <div>
            <div class="field-label">المبنى</div>
            <select id="buildingSelect">
              <option value="A">المبنى A - التنويم</option>
              <option value="B">المبنى B - العناية المركزة</option>
              <option value="C">المبنى C - العيادات</option>
            </select>
          </div>

          <div>
            <div class="field-label">الدور</div>
            <select id="floorSelect">
              <option value="4">الدور الرابع - باطنية</option>
              <option value="3">الدور الثالث - جراحة</option>
              <option value="2">الدور الثاني - عظام</option>
              <option value="1">الدور الأول - طوارئ</option>
            </select>
          </div>

          <div style="margin-top: 6px;">
            <div class="field-label">نظرة سريعة</div>
            <div class="quick-stats" id="quickStats"></div>
          </div>
        </div>
      </aside>

      <!-- خريطة الأسرة -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">خريطة الأسرة التفاعلية</div>
            <div class="card-subtitle">عرض حي لحالة الأسرة في الجناح المختار</div>
          </div>
          <div class="toggle-wrapper">
            <button class="toggle-btn active" onclick="setView('ward')">عرض جناح</button>
            <button class="toggle-btn" onclick="setView('rooms')">عرض غرف</button>
          </div>
        </div>

        <div class="map-container">
          <div class="map-toolbar">
            <span class="muted" style="font-size: 12px;">
              يتم تحديث حالة السرير آلياً من الحساسات أو النظام الطبي.
            </span>
          </div>

          <div class="map-wrapper">
            <div class="ward-label" id="wardLabel">الجناح 4B - باطنية نساء</div>
            <div class="bed-grid" id="bedGrid">
              <!-- الأسرّة من JS -->
            </div>
            <!-- ==== شبكة الغرف (مخفية بالبداية) ==== -->
            <div id="roomsGrid" class="rooms-grid" style="display:none;"></div>
          </div>

          <div class="legend">
            <div class="legend-item">
              <span class="legend-dot free"></span> متاح
            </div>
            <div class="legend-item">
              <span class="legend-dot occupied"></span> مشغول
            </div>
            <div class="legend-item">
              <span class="legend-dot discharge"></span> قريب الخروج
            </div>
            <div class="legend-item">
              <span class="legend-dot isolation"></span> عزل
            </div>
            <div class="legend-item">
              <span class="legend-dot outofservice"></span> خارج الخدمة
            </div>
          </div>
        </div>
      </section>

      <!-- تفاصيل السرير -->
      <aside class="card details-panel">
        <div class="card-header">
          <div>
            <div class="card-title">تفاصيل السرير</div>
            <div class="card-subtitle">اختَر سريراً من الخريطة لعرض التفاصيل</div>
          </div>
        </div>

        <div class="details" id="detailsContainer">
          <div class="details-section">
            <div class="details-row">
              <span class="details-label">رقم السرير</span>
              <span class="details-value" id="detailBedId">—</span>
            </div>
            <div class="details-row">
              <span class="details-label">الحالة</span>
              <span class="details-value" id="detailStatus">—</span>
            </div>
            <div class="details-row">
              <span class="details-label">المريض</span>
              <span class="details-value" id="detailPatient">—</span>
            </div>
            <div class="details-row">
              <span class="details-label">متوقع الخروج</span>
              <span class="details-value" id="detailEta">—</span>
            </div>
            <div class="details-row">
              <span class="details-label">الممرض المسؤول</span>
              <span class="details-value" id="detailNurse">—</span>
            </div>
          </div>

          <button class="btn-secondary" type="button" id="sendTransferRequestBtn" disabled style="margin-top: 10px;">
            إرسال طلب تحويل لمستشفى آخر
          </button>

          <button class="btn-secondary" type="button" id="internalTransferBtn" style="margin-top: 10px;">
            التحويل الداخلي بين الأقسام
          </button>

          <div class="chips-row">
            <span class="chip-soft">نسبة تمريض/مرضى: <span id="nurseRatio">1 : 5.5</span></span>
            <span class="chip-soft">ضغط الجناح: <span id="wardLoad">مرتفع</span></span>
            <span class="chip-soft">وضع المواسم: <span id="seasonChip">عادي</span></span>
          </div>
        </div>
      </aside>
    </div>

    <!-- تحليل الذكاء الاصطناعي (تحت الخريطة) -->
    <div class="card ai-analysis-card">
      <div class="ai-box" id="aiBox">
        <div class="ai-empty-state">
          <div class="ai-empty-state-icon"></div>
          <div class="ai-empty-state-text">اختر سريراً لعرض تحليل الذكاء الاصطناعي</div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal إرسال طلب تحويل -->
<div class="modal-overlay" id="transferRequestModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">إرسال طلب تحويل لمستشفى آخر</div>
      <button class="modal-close" onclick="closeTransferModal()">&times;</button>
    </div>
    <form id="transferRequestForm">
      <div class="modal-field">
        <label class="modal-label">اسم المريض</label>
        <input type="text" class="modal-input" id="modalPatientName" readonly>
      </div>
      <div class="modal-field">
        <label class="modal-label">حالة المريض</label>
        <input type="text" class="modal-input" id="modalPatientStatus" readonly>
      </div>
      <div class="modal-field">
        <label class="modal-label">المستشفى المستقبل</label>
        <select class="modal-select" id="modalTargetHospital" required>
          <option value="">اختر المستشفى</option>
          <option value="النور">مستشفى النور التخصصي</option>
          <option value="الملك عبدالله">مدينة الملك عبدالله الطبية</option>
          <option value="حراء">مستشفى حراء</option>
          <option value="الولادة">مستشفى الولادة والأطفال</option>
        </select>
      </div>
      <div class="modal-field">
        <label class="modal-label">سبب التحويل</label>
        <textarea class="modal-textarea" id="modalTransferReason" placeholder="اذكر سبب التحويل..." required></textarea>
      </div>
      <div class="modal-field">
        <label class="modal-label">أولوية التحويل (تلقائية من AI)</label>
        <input type="text" class="modal-input" id="modalPriority" readonly>
      </div>
      <div class="modal-ai-check" id="modalAICheck">
        <div class="modal-ai-status checking">
          <span>يتم تحليل السعة في المستشفى الهدف...</span>
        </div>
        <div id="modalAIResult" style="font-size: 12px; color: #666; margin-top: 6px;"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeTransferModal()">إلغاء</button>
        <button type="submit" class="modal-btn modal-btn-primary" id="modalSubmitBtn" disabled>إرسال الطلب</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal التحويل الداخلي -->
<div class="modal-overlay" id="internalTransferModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">التحويل الداخلي بين الأقسام</div>
      <button class="modal-close" onclick="closeInternalTransferModal()">&times;</button>
    </div>
    <form id="internalTransferForm">
      <div class="modal-field">
        <label class="modal-label">السرير</label>
        <input type="text" class="modal-input" id="internalBedId" readonly>
      </div>
      <div class="modal-field">
        <label class="modal-label">المريض</label>
        <input type="text" class="modal-input" id="internalPatientName" readonly>
      </div>
      <div class="modal-field">
        <label class="modal-label">القسم الحالي</label>
        <select class="modal-select" id="sourceWard" required>
          <option value="">اختر القسم</option>
          <option value="4B">الجناح 4B - باطنية نساء</option>
          <option value="3B">الجناح 3B - جراحة</option>
          <option value="2B">الجناح 2B - عظام</option>
          <option value="1A">الجناح 1A - طوارئ</option>
          <option value="5C">الجناح 5C - قلب</option>
          <option value="ICU">العناية المركزة</option>
        </select>
        <div id="sourceWardInfo" style="margin-top: 8px; font-size: 12px; color: #777;"></div>
      </div>
      <div class="modal-field">
        <label class="modal-label">القسم المستقبل</label>
        <select class="modal-select" id="targetWard" required>
          <option value="">اختر القسم</option>
          <option value="4B">الجناح 4B - باطنية نساء</option>
          <option value="3B">الجناح 3B - جراحة</option>
          <option value="2B">الجناح 2B - عظام</option>
          <option value="1A">الجناح 1A - طوارئ</option>
          <option value="5C">الجناح 5C - قلب</option>
          <option value="ICU">العناية المركزة</option>
        </select>
        <div id="targetWardInfo" style="margin-top: 8px; font-size: 12px; color: #777;"></div>
      </div>
      <div class="modal-ai-check" id="internalAIBox" style="display: none;">
        <div class="modal-ai-status checking">
          <span>يتم تحليل إمكانية التحويل...</span>
        </div>
        <div id="internalAIText" style="font-size: 12px; color: #666; margin-top: 6px;"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeInternalTransferModal()">إلغاء</button>
        <button type="submit" class="modal-btn modal-btn-primary" id="internalTransferSubmitBtn" disabled>بدء التحويل</button>
      </div>
    </form>
  </div>
</div>

<script>
  // بيانات تجريبية للأسِرّة – تقدرِين تربطيها لاحقاً من الـ API
  const beds = [
    { id: "B401", status: "free", patient: null, eta: null, nurse: "حنان السلمي", triage: "LOW" },
    { id: "B402", status: "occupied", patient: "سعاد أحمد", eta: "اليوم 23:30", nurse: "ليان التركي", triage: "MEDIUM" },
    { id: "B403", status: "occupied", patient: "وفاء العتيبي", eta: "غداً 10:00", nurse: "ريم الزهراني", triage: "HIGH" },
    { id: "B404", status: "discharge", patient: "نورة الحربي", eta: "اليوم 18:00", nurse: "نوف الحسين", triage: "LOW" },
    { id: "B405", status: "isolation", patient: "حالة عزل 001", eta: "غير محدد", nurse: "نهى الشهري", triage: "HIGH" },
    { id: "B406", status: "free", patient: null, eta: null, nurse: "حنان السلمي", triage: "LOW" },
    { id: "B407", status: "occupied", patient: "مشاعل المطيري", eta: "بعد 48 ساعة", nurse: "ليان التركي", triage: "MEDIUM" },
    { id: "B408", status: "outofservice", patient: null, eta: null, nurse: "—", triage: "NA" },
    { id: "B409", status: "occupied", patient: "حصة القحطاني", eta: "اليوم 21:00", nurse: "ريم الزهراني", triage: "HIGH" },
    { id: "B410", status: "discharge", patient: "نجلاء القرني", eta: "اليوم 17:15", nurse: "نوف الحسين", triage: "MEDIUM" },
    { id: "B411", status: "free", patient: null, eta: null, nurse: "حنان السلمي", triage: "LOW" },
    { id: "B412", status: "isolation", patient: "حالة عزل 002", eta: "غير محدد", nurse: "نهى الشهري", triage: "HIGH" },
  ];

  let selectedBedId = null;
  let seasonMode = false;

  const bedGrid = document.getElementById("bedGrid");
  const quickStatsContainer = document.getElementById("quickStats");

  const detailBedId = document.getElementById("detailBedId");
  const detailStatus = document.getElementById("detailStatus");
  const detailPatient = document.getElementById("detailPatient");
  const detailEta = document.getElementById("detailEta");
  const detailNurse = document.getElementById("detailNurse");

  const aiBox = document.getElementById("aiBox");

  const nurseRatio = document.getElementById("nurseRatio");
  const wardLoad = document.getElementById("wardLoad");
  const seasonChip = document.getElementById("seasonChip");

  function statusToArabic(status) {
    switch (status) {
      case "free": return "متاح";
      case "occupied": return "مشغول";
      case "discharge": return "قريب الخروج";
      case "isolation": return "عزل";
      case "outofservice": return "خارج الخدمة";
      default: return "غير معروف";
    }
  }

  function buildBedGrid() {
    bedGrid.innerHTML = "";

    beds.forEach(bed => {
      const div = document.createElement("div");
      div.className = `bed status-${bed.status}`;
      div.dataset.bedId = bed.id;

      const head = document.createElement("div");
      head.className = "bed-head";

      const body = document.createElement("div");
      body.className = "bed-body";

      const row1 = document.createElement("div");
      row1.className = "bed-row";

      const spanId = document.createElement("span");
      spanId.className = "bed-id";
      spanId.textContent = bed.id;

      const statusPill = document.createElement("span");
      statusPill.className = "bed-status-pill";

      const statusDot = document.createElement("span");
      statusDot.className = "bed-status-dot";

      const statusText = document.createElement("span");
      statusText.textContent = statusToArabic(bed.status);

      statusPill.appendChild(statusDot);
      statusPill.appendChild(statusText);
      row1.appendChild(spanId);
      row1.appendChild(statusPill);

      const row2 = document.createElement("div");
      row2.className = "bed-row";

      const meta = document.createElement("span");
      meta.className = "bed-meta";

      if (bed.patient) {
        meta.textContent = bed.patient;
      } else {
        meta.textContent = "لا يوجد مريض";
      }

      const eta = document.createElement("span");
      eta.className = "bed-meta";
      eta.textContent = bed.eta ? bed.eta : "—";

      row2.appendChild(meta);
      row2.appendChild(eta);

      body.appendChild(row1);
      body.appendChild(row2);

      // تغيير ألوان الأسرة في موسم الحج
      if (seasonMode) {
        if (bed.status === "free") {
          body.style.background = "linear-gradient(135deg,#e8f7ff,#f0fbff)";
        }
        if (bed.status === "discharge") {
          body.style.background = "linear-gradient(135deg,#fff2c9,#fff6dd)";
        }
        if (bed.status === "isolation") {
          body.style.background = "linear-gradient(135deg,#f1ddff,#f7eaff)";
        }
      }

      div.appendChild(head);
      div.appendChild(body);

      div.addEventListener("click", () => onBedClicked(bed.id));

      bedGrid.appendChild(div);
    });
  }

  function calculateQuickStats() {
    const stats = {
      free: 0,
      occupied: 0,
      discharge: 0,
      isolation: 0,
      outofservice: 0,
    };

    beds.forEach(b => {
      if (stats[b.status] !== undefined) {
        stats[b.status]++;
      }
    });

    quickStatsContainer.innerHTML = "";

    const statItems = [
      { label: "متاح", key: "free" },
      { label: "مشغول", key: "occupied" },
      { label: "قريب الخروج", key: "discharge" },
      { label: "عزل", key: "isolation" },
      { label: "خارج الخدمة", key: "outofservice" },
      { label: "إجمالي الأسرة", key: "total" },
    ];

    statItems.forEach(item => {
      const value = item.key === "total"
        ? beds.length
        : stats[item.key];

      const statDiv = document.createElement("div");
      statDiv.className = "stat-badge";

      const strong = document.createElement("strong");
      strong.textContent = value;

      const span = document.createElement("span");
      span.textContent = item.label;

      statDiv.appendChild(strong);
      statDiv.appendChild(span);

      quickStatsContainer.appendChild(statDiv);
    });

    // تحديث حمل الجناح بشكل بسيط بناءً على نسبة الإشغال
    const occupiedRatio = stats.occupied / beds.length;
    
    // في موسم الحج نرفع الحساسية: أي جناح فوق 55% يعتبر "مرتفع"
    let adjustedOccupiedRatio = occupiedRatio;
    if (seasonMode) {
      if (occupiedRatio >= 0.55) {
        adjustedOccupiedRatio = 0.8;
      } else if (occupiedRatio >= 0.35) {
        adjustedOccupiedRatio = 0.6;
      }
    }

    if (adjustedOccupiedRatio >= 0.8) {
      wardLoad.textContent = "حرج";
    } else if (adjustedOccupiedRatio >= 0.6) {
      wardLoad.textContent = "مرتفع";
    } else if (adjustedOccupiedRatio >= 0.3) {
      wardLoad.textContent = "متوسط";
    } else {
      wardLoad.textContent = "منخفض";
    }
  }

  function onBedClicked(bedId) {
    selectedBedId = bedId;
    const bed = beds.find(b => b.id === bedId);
    if (!bed) return;

    // تمييز السرير المحدد
    document.querySelectorAll(".bed").forEach(el => {
      el.classList.toggle("selected", el.dataset.bedId === bedId);
    });

    // تعبئة التفاصيل
    detailBedId.textContent = bed.id;
    detailStatus.textContent = statusToArabic(bed.status);
    detailPatient.textContent = bed.patient || "لا يوجد مريض على السرير";
    detailEta.textContent = bed.eta || "—";
    detailNurse.textContent = bed.nurse;

    // بناء تحليل AI الجديد
    buildAIAnalysis(bed);
    
    // تحديث زر إرسال طلب التحويل
    const sendTransferRequestBtn = document.getElementById("sendTransferRequestBtn");
    sendTransferRequestBtn.disabled = !bed.patient || bed.status === "free";
  }

  // بيانات الغرف (تعديلها لاحقاً حسب الحاجة)
  const rooms = [
    {
      room: "401",
      status: "clean",
      bed: "B401",
      bedStatus: "free",
      ward: "4B"
    },
    {
      room: "402",
      status: "busy",
      bed: "B402",
      bedStatus: "occupied",
      ward: "4B"
    },
    {
      room: "403",
      status: "isolation",
      bed: "B405",
      bedStatus: "isolation",
      ward: "4B"
    },
    {
      room: "404",
      status: "busy",
      bed: "B403",
      bedStatus: "occupied",
      ward: "4B"
    },
    {
      room: "405",
      status: "clean",
      bed: "B406",
      bedStatus: "free",
      ward: "4B"
    },
    {
      room: "406",
      status: "busy",
      bed: "B407",
      bedStatus: "occupied",
      ward: "4B"
    },
    {
      room: "407",
      status: "clean",
      bed: "B411",
      bedStatus: "free",
      ward: "4B"
    },
    {
      room: "408",
      status: "isolation",
      bed: "B412",
      bedStatus: "isolation",
      ward: "4B"
    }
  ];

  // رسم الغرف
  function loadRooms() {
    const grid = document.getElementById("roomsGrid");
    grid.innerHTML = "";

    rooms.forEach(r => {
      const card = document.createElement("div");
      card.className = "room-card";
      card.innerHTML = `
        <div class="room-title">غرفة ${r.room}</div>
        <div class="room-bed">
          <span>سرير ${r.bed}</span>
          <span>${statusToArabic(r.bedStatus)}</span>
        </div>
        <span class="room-status room-status-${r.status}">
          ${getRoomStatusArabic(r.status)}
        </span>
      `;
      grid.appendChild(card);
    });
  }

  // نص عربي لحالة الغرفة
  function getRoomStatusArabic(s) {
    return {
      clean: "نظيفة",
      busy: "مشغولة",
      isolation: "عزل"
    }[s] || s;
  }

  // زر التبديل
  function setView(type) {
    const wing = document.getElementById("bedGrid");
    const roomsGrid = document.getElementById("roomsGrid");
    const wardLabel = document.getElementById("wardLabel");
    const toggleBtns = document.querySelectorAll(".toggle-btn");

    toggleBtns.forEach(btn => btn.classList.remove("active"));

    if (type === "ward") {
      wing.style.display = "grid";
      roomsGrid.style.display = "none";
      wardLabel.textContent = "الجناح 4B - باطنية نساء";
      toggleBtns[0].classList.add("active");
    } else {
      wing.style.display = "none";
      roomsGrid.style.display = "grid";
      wardLabel.textContent = "عرض حسب الغرف - الجناح 4B";
      loadRooms();
      toggleBtns[1].classList.add("active");
    }
  }

  function buildAIAnalysis(bed) {
    // تحديد بيانات التحليل حسب triage
    let aiData = {
      score: "LOW",
      scoreText: "LOW – مستقرة",
      scoreClass: "",
      reasons: [],
      indicators: {},
      recommendation: ""
    };

    switch (bed.triage) {
      case "HIGH":
        aiData.score = "HIGH";
        aiData.scoreText = "HIGH – حالة عالية الخطورة";
        aiData.scoreClass = "high";
        aiData.reasons = [
          "الحالة تحتاج متابعة مستمرة ومراقبة مكثفة",
          "الجناح الحالي يعاني من ضغط عالي (نسبة ممرض/مريض 1:7)",
          "يُنصح بمراجعة أولوية السرير خلال 15 دقيقة",
          "تقييم إمكانية نقل حالة مستقرة لفتح سرير احتياطي"
        ];
        aiData.indicators = {
          wardPressure: "مرتفع",
          equipment: "يحتاج أجهزة متخصصة",
          bedType: "سرير عزل/عناية",
          nurseRatio: "مرتفعة (1:6.5)",
          riskLevel: "عالي"
        };
        aiData.recommendation = "يوصى بمراجعة أولوية السرير خلال 15 دقيقة، مع تقييم إمكانية نقل حالة مستقرة من نفس الجناح لفتح سرير احتياطي لاستقبال حالة حرجة جديدة.";
        break;
      case "MEDIUM":
        aiData.score = "MEDIUM";
        aiData.scoreText = "MEDIUM – متوسطة الخطورة";
        aiData.scoreClass = "medium";
        aiData.reasons = [
          "المريضة في مرحلة التعافي وتحتاج رعاية أقل كثافة",
          "يمكن نقلها إلى جناح أقل ضغطاً",
          "لتحرير سرير للحالات الحرجة",
          "الجناح الحالي متوسط الضغط (1:5.5)"
        ];
        aiData.indicators = {
          wardPressure: "متوسط",
          equipment: "لا يحتاج",
          bedType: "سرير عادي",
          nurseRatio: "متوسطة (1:5.5)",
          riskLevel: "متوسط"
        };
        aiData.recommendation = "يمكن التخطيط لتحويل المريضة إلى جناح أقل ضغطاً خلال الساعتين القادمتين، لخفض نسبة الحمل التمريضي في هذا الجناح.";
        break;
      case "LOW":
        aiData.score = "LOW";
        aiData.scoreText = "LOW – مستقرة";
        aiData.scoreClass = "";
        aiData.reasons = [
          "السرير مناسب لحالات الاستقرار",
          "لا يحتاج لمراقبة مكثفة",
          "الجناح خفيف الضغط (1:5)",
          "مناسب للاستخدام عند ارتفاع الضغط في الطوارئ"
        ];
        aiData.indicators = {
          wardPressure: "منخفض",
          equipment: "لا يحتاج",
          bedType: "سرير عادي",
          nurseRatio: "منخفضة (1:4.5)",
          riskLevel: "منخفض"
        };
        aiData.recommendation = "لا حاجة لتحويل فوري. يمكن استخدام هذا السرير ضمن خطة إعادة توزيع الحالات إذا زاد الضغط في قسم الطوارئ.";
        break;
      default:
        aiData.score = "NA";
        aiData.scoreText = "غير محدد";
        aiData.reasons = ["لا توجد بيانات كافية لحساب أولوية التحويل"];
        aiData.indicators = {
          wardPressure: "—",
          equipment: "—",
          bedType: "—",
          nurseRatio: "—",
          riskLevel: "—"
        };
        aiData.recommendation = "لا توجد بيانات كافية لحساب أولوية التحويل لهذه الحالة.";
    }

    // تطبيق منطق المواسم - رفع حساسية triage
    if (seasonMode) {
      // رفع حساسية triage في موسم الحج
      if (aiData.score === "LOW") {
        // LOW يصير أقرب لـ MEDIUM
        aiData.score = "MEDIUM";
        aiData.scoreText = "MEDIUM – متوسطة (موسم الحج: حساسية مرتفعة)";
        aiData.scoreClass = "medium";
        aiData.reasons.unshift("في موسم الحج: تم رفع الأولوية لتوفير سرير لاستقبال حالات حرجة");
      } else if (aiData.score === "MEDIUM") {
        // MEDIUM يعامل كـ HIGH
        aiData.score = "HIGH";
        aiData.scoreText = "HIGH – عالية (موسم الحج: أولوية قصوى)";
        aiData.scoreClass = "high";
        aiData.reasons.unshift("في موسم الحج: تم رفع الأولوية القصوى - يُفضّل إخلاء السرير قريباً");
      } else if (aiData.score === "HIGH") {
        // HIGH يبقى HIGH لكن بصياغة حج
        aiData.scoreText = "HIGH – حرجة جداً (موسم الحج: إخلاء فوري)";
        aiData.reasons.unshift("في موسم الحج: حالة حرجة جداً - إخلاء السرير فوراً لاستقبال حجاج/معتمرين");
      }
      
      aiData.reasons.push("تم تطبيق منطق المواسم: الأولوية القصوى لتوفير أسرّة لاستقبال حجاج أو معتمرين");
      aiData.recommendation += " (تم تطبيق منطق المواسم: الأولوية القصوى لتوفير أسرّة لاستقبال حجاج أو معتمرين في المسار السريع).";
    }

    // بناء HTML
    const aiHTML = `
      <div class="ai-title">مساعد التحويل الذكي</div>

      <!-- AI Score -->
      <div class="ai-section">
        <div class="ai-section-title">تصنيف الحالة:</div>
        <span class="ai-score ${aiData.scoreClass}">${aiData.scoreText}</span>
      </div>

      <!-- Reasons -->
      <div class="ai-section ai-reasons">
        <div class="ai-section-title">أسباب التحليل:</div>
        <ul>
          ${aiData.reasons.map(reason => `<li>${reason}</li>`).join('')}
        </ul>
      </div>

      <!-- Indicators -->
      <div class="ai-section">
        <div class="ai-section-title">المؤشرات:</div>
        <div class="ai-badge">ضغط الجناح: ${aiData.indicators.wardPressure}</div>
        <div class="ai-badge">متطلبات الأجهزة: ${aiData.indicators.equipment}</div>
        <div class="ai-badge">نوع السرير المناسب: ${aiData.indicators.bedType}</div>
        <div class="ai-badge">نسبة التمريض: ${aiData.indicators.nurseRatio}</div>
        <div class="ai-badge">خطر التدهور: ${aiData.indicators.riskLevel}</div>
      </div>

      <!-- Final Recommendation -->
      <div class="ai-section">
        <div class="ai-section-title">الخلاصة:</div>
        <div class="ai-recommend-text">
          ${aiData.recommendation}
        </div>
      </div>
    `;

    aiBox.innerHTML = aiHTML;
  }

  function initPills() {
    // تم استبدالها بـ setView
  }

  function initSeasonToggle() {
    const seasonBanner = document.getElementById("seasonBanner");
    
    // قراءة الحالة من localStorage
    function loadSeasonMode() {
      const saved = localStorage.getItem('seasonMode');
      seasonMode = saved === 'true';
      
      if (seasonChip) {
        seasonChip.textContent = seasonMode ? "حج / رمضان" : "عادي";
      }
      
      if (seasonBanner) {
        seasonBanner.style.display = seasonMode ? "block" : "none";
      }
      
      if (seasonMode) {
        if (nurseRatio) nurseRatio.textContent = "1 : 6.5";
      } else {
        if (nurseRatio) nurseRatio.textContent = "1 : 5.5";
      }
      
      // إعادة بناء الإحصائيات والأسرة
      calculateQuickStats();
      buildBedGrid();
      
      // إذا كان هناك سرير محدد، إعادة بناء تحليل AI
      if (selectedBedId) {
        const bed = beds.find(b => b.id === selectedBedId);
        if (bed) {
          buildAIAnalysis(bed);
        }
      }
    }
    
    // تحميل الحالة عند تحميل الصفحة
    loadSeasonMode();
    
    // الاستماع لتغييرات localStorage من الصفحات الأخرى
    window.addEventListener('storage', (e) => {
      if (e.key === 'seasonMode') {
        loadSeasonMode();
      }
    });
    
    // فحص التغييرات كل ثانية (للاستخدام في نفس الصفحة)
    setInterval(() => {
      const saved = localStorage.getItem('seasonMode');
      const currentMode = saved === 'true';
      if (currentMode !== seasonMode) {
        loadSeasonMode();
      }
    }, 1000);
  }

  function initTransferButton() {
    const sendTransferRequestBtn = document.getElementById("sendTransferRequestBtn");
    sendTransferRequestBtn.addEventListener("click", () => {
      if (!selectedBedId) return;
      openTransferModal();
    });
  }

  // بيانات المستشفيات (للمحاكاة)
  const hospitalsData = {
    "النور": { load: 44, ratio: "1:4.8", hasCapacity: true, waitTime: 0 },
    "الملك عبدالله": { load: 62, ratio: "1:5.2", hasCapacity: true, waitTime: 15 },
    "حراء": { load: 78, ratio: "1:6.8", hasCapacity: false, waitTime: 0 },
    "الولادة": { load: 55, ratio: "1:5.5", hasCapacity: true, waitTime: 20 }
  };

  function openTransferModal() {
    const bed = beds.find(b => b.id === selectedBedId);
    if (!bed || !bed.patient) {
      alert("يرجى اختيار سرير يحتوي على مريض");
      return;
    }

    const modal = document.getElementById("transferRequestModal");
    document.getElementById("modalPatientName").value = bed.patient;
    document.getElementById("modalPatientStatus").value = statusToArabic(bed.status);
    document.getElementById("modalPriority").value = bed.triage === "HIGH" ? "عالية" : bed.triage === "MEDIUM" ? "متوسطة" : "منخفضة";
    
    modal.classList.add("active");
    
    // إعادة تعيين الحقول
    document.getElementById("modalTargetHospital").value = "";
    document.getElementById("modalTransferReason").value = "";
    document.getElementById("modalSubmitBtn").disabled = true;
    checkAICapacity();
  }

  function closeTransferModal() {
    const modal = document.getElementById("transferRequestModal");
    modal.classList.remove("active");
  }

  function checkAICapacity() {
    const hospitalSelect = document.getElementById("modalTargetHospital");
    const aiStatus = document.querySelector("#modalAICheck .modal-ai-status");
    const aiResult = document.getElementById("modalAIResult");
    const submitBtn = document.getElementById("modalSubmitBtn");
    
    hospitalSelect.addEventListener("change", () => {
      const selectedHospital = hospitalSelect.value;
      if (!selectedHospital) {
        aiStatus.className = "modal-ai-status checking";
        aiStatus.innerHTML = "<span>يتم تحليل السعة في المستشفى الهدف...</span>";
        aiResult.textContent = "";
        submitBtn.disabled = true;
        return;
      }

      const hospital = hospitalsData[selectedHospital];
      const bed = beds.find(b => b.id === selectedBedId);
      
      // محاكاة التحقق من AI
      setTimeout(() => {
        if (hospital.hasCapacity) {
          if (hospital.waitTime === 0) {
            aiStatus.className = "modal-ai-status success";
            aiStatus.innerHTML = "<span>يمكن إرسال الطلب — يوجد احتمال قبول</span>";
            aiResult.textContent = "التحليل يشير إلى أن المستشفى لديه سعة مناسبة لاستقبال الحالة.";
            submitBtn.disabled = false;
          } else {
            aiStatus.className = "modal-ai-status warning";
            aiStatus.innerHTML = `<span>⚠ التحويل ممكن لكن فيه انتظار لمدة ${hospital.waitTime} دقيقة</span>`;
            aiResult.textContent = `المستشفى لديه سعة لكن قد يحتاج إلى ${hospital.waitTime} دقيقة لإعداد السرير.`;
            submitBtn.disabled = false;
          }
        } else {
          aiStatus.className = "modal-ai-status error";
          aiStatus.innerHTML = "<span>التحويل غير ممكن — لا توجد سعة مناسبة</span>";
          aiResult.textContent = "المستشفى يعاني من ضغط عالي ولا يمكنه استقبال حالات جديدة في الوقت الحالي.";
          submitBtn.disabled = true;
        }
      }, 1000);
    });
  }

  // إرسال الطلب
  document.getElementById("transferRequestForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const hospital = document.getElementById("modalTargetHospital").value;
    const reason = document.getElementById("modalTransferReason").value;
    const bed = beds.find(b => b.id === selectedBedId);
    
    alert(`تم إرسال طلب التحويل بنجاح!\n\nالمريض: ${bed.patient}\nالمستشفى المستقبل: ${hospital}\nسبب التحويل: ${reason}`);
    closeTransferModal();
  });

  // تحديث حالة الزر عند اختيار سرير
  const originalOnBedClicked = onBedClicked;
  onBedClicked = function(bedId) {
    originalOnBedClicked(bedId);
    const bed = beds.find(b => b.id === bedId);
    const sendTransferRequestBtn = document.getElementById("sendTransferRequestBtn");
    sendTransferRequestBtn.disabled = !bed || !bed.patient || bed.status === "free";
  };

  /* ============================================================
    التحويل الداخلي بين الأقسام
  ============================================================ */
  const wardsData = {
    "4B": { name: "الجناح 4B - باطنية نساء", load: 88, ratio: "1:6.0", availableBeds: 3, totalBeds: 20 },
    "3B": { name: "الجناح 3B - جراحة", load: 73, ratio: "1:5.5", availableBeds: 5, totalBeds: 18 },
    "2B": { name: "الجناح 2B - عظام", load: 65, ratio: "1:5.0", availableBeds: 7, totalBeds: 20 },
    "1A": { name: "الجناح 1A - طوارئ", load: 90, ratio: "1:6.5", availableBeds: 2, totalBeds: 20 },
    "5C": { name: "الجناح 5C - قلب", load: 58, ratio: "1:4.5", availableBeds: 8, totalBeds: 19 },
    "ICU": { name: "العناية المركزة", load: 78, ratio: "1:2.5", availableBeds: 4, totalBeds: 18 }
  };

  function updateWardInfo(selectId, infoId) {
    const select = document.getElementById(selectId);
    const info = document.getElementById(infoId);
    
    select.addEventListener("change", () => {
      const wardId = select.value;
      if (wardId && wardsData[wardId]) {
        const ward = wardsData[wardId];
        info.innerHTML = `
          <div><strong>الضغط:</strong> ${ward.load}%</div>
          <div><strong>نسبة التمريض:</strong> ${ward.ratio}</div>
          <div><strong>الأسرة المتاحة:</strong> ${ward.availableBeds}</div>
        `;
      } else {
        info.innerHTML = "";
      }
      
      checkInternalTransfer();
    });
  }

  function checkInternalTransfer() {
    const sourceWard = document.getElementById("sourceWard").value;
    const targetWard = document.getElementById("targetWard").value;
    const internalAIBox = document.getElementById("internalAIBox");
    const internalAIText = document.getElementById("internalAIText");
    const internalTransferSubmitBtn = document.getElementById("internalTransferSubmitBtn");
    const aiStatus = document.querySelector("#internalAIBox .modal-ai-status");
    
    if (!sourceWard || !targetWard || sourceWard === targetWard) {
      internalAIBox.style.display = "none";
      internalTransferSubmitBtn.disabled = true;
      return;
    }
    
    const source = wardsData[sourceWard];
    const target = wardsData[targetWard];
    
    if (!source || !target) return;
    
    internalAIBox.style.display = "block";
    
    // محاكاة التحقق من AI
    setTimeout(() => {
      // منطق AI للتحويل الداخلي
      let recommendation = "";
      let canTransfer = false;
      
      if (target.load > 85) {
        aiStatus.className = "modal-ai-status error";
        recommendation = `⚠ القسم المستقبل (${target.name}) يعاني من ضغط عالي (${target.load}%). يُنصح بالانتظار أو اختيار قسم آخر.`;
        canTransfer = false;
      } else if (target.availableBeds === 0) {
        aiStatus.className = "modal-ai-status error";
        recommendation = `لا توجد أسرة متاحة في القسم المستقبل (${target.name}).`;
        canTransfer = false;
      } else if (target.load < source.load && target.availableBeds >= 2) {
        aiStatus.className = "modal-ai-status success";
        recommendation = `التحويل موصى به. القسم المستقبل (${target.name}) لديه ضغط أقل (${target.load}% مقابل ${source.load}%) وأسرة متاحة (${target.availableBeds} سرير).`;
        canTransfer = true;
      } else if (target.availableBeds >= 1) {
        aiStatus.className = "modal-ai-status warning";
        recommendation = `✓ التحويل ممكن. القسم المستقبل (${target.name}) لديه ${target.availableBeds} سرير متاح.`;
        canTransfer = true;
      } else {
        aiStatus.className = "modal-ai-status warning";
        recommendation = `⚠ القسم المستقبل (${target.name}) لديه سعة محدودة. يُنصح بالتحقق من الأقسام الأخرى.`;
        canTransfer = false;
      }
      
      internalAIText.textContent = recommendation;
      internalTransferSubmitBtn.disabled = !canTransfer;
    }, 500);
  }

  function openInternalTransferModal() {
    const modal = document.getElementById("internalTransferModal");
    const bed = selectedBedId ? beds.find(b => b.id === selectedBedId) : null;
    
    if (bed) {
      document.getElementById("internalBedId").value = bed.id;
      document.getElementById("internalPatientName").value = bed.patient || "لا يوجد مريض";
    } else {
      document.getElementById("internalBedId").value = "يرجى اختيار سرير أولاً";
      document.getElementById("internalPatientName").value = "—";
    }
    
    // إعادة تعيين الحقول
    document.getElementById("sourceWard").value = "";
    document.getElementById("targetWard").value = "";
    document.getElementById("sourceWardInfo").innerHTML = "";
    document.getElementById("targetWardInfo").innerHTML = "";
    document.getElementById("internalAIBox").style.display = "none";
    document.getElementById("internalTransferSubmitBtn").disabled = true;
    
    modal.classList.add("active");
    checkInternalTransfer();
  }

  function closeInternalTransferModal() {
    const modal = document.getElementById("internalTransferModal");
    modal.classList.remove("active");
  }

  function initInternalTransfer() {
    const internalTransferBtn = document.getElementById("internalTransferBtn");
    internalTransferBtn.addEventListener("click", () => {
      openInternalTransferModal();
    });

    updateWardInfo("sourceWard", "sourceWardInfo");
    updateWardInfo("targetWard", "targetWardInfo");
    
    // إرسال النموذج
    document.getElementById("internalTransferForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const sourceWard = document.getElementById("sourceWard").value;
      const targetWard = document.getElementById("targetWard").value;
      const source = wardsData[sourceWard];
      const target = wardsData[targetWard];
      const bed = selectedBedId ? beds.find(b => b.id === selectedBedId) : null;
      
      if (!source || !target) return;
      
      if (bed) {
        if (confirm(`هل أنت متأكد من بدء التحويل الداخلي للسرير ${bed.id} من ${source.name} إلى ${target.name}؟`)) {
          alert(`تم بدء عملية التحويل الداخلي\nالسرير: ${bed.id}\nالمريض: ${bed.patient || "لا يوجد"}\nمن: ${source.name}\nإلى: ${target.name}\n\nسيتم إشعار القسمين بالتحويل.`);
          closeInternalTransferModal();
        }
      } else {
        if (confirm(`هل أنت متأكد من بدء التحويل الداخلي من ${source.name} إلى ${target.name}؟`)) {
          alert(`تم بدء عملية التحويل الداخلي\nمن: ${source.name}\nإلى: ${target.name}\n\nيرجى اختيار السرير المراد تحويله.`);
          closeInternalTransferModal();
        }
      }
    });
  }

  function init() {
    buildBedGrid();
    calculateQuickStats();
    initPills();
    initSeasonToggle();
    initTransferButton();
    initInternalTransfer();
  }

  document.addEventListener("DOMContentLoaded", init);
</script>

<script>
  function openMenu() {
    const menu = document.getElementById("mobileMenu");
    if (menu) {
      menu.style.display = "block";
    }
  }

  function closeMenu() {
    const menu = document.getElementById("mobileMenu");
    if (menu) {
      menu.style.display = "none";
    }
  }
</script>
</body>
</html>
